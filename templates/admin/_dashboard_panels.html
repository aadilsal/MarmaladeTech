{% load humanize %}
<div class="container">
  <h1 class="display-5 mb-4">Admin Dashboard</h1>

  <div class="row g-4 mb-4">
    <div class="col-md-2">
      <div class="card p-3">
        <h6 class="mb-2">Users</h6>
        <div class="fs-3 fw-bold">{{ total_users }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card p-3">
        <h6 class="mb-2">Quizzes</h6>
        <div class="fs-3 fw-bold">{{ total_quizzes }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card p-3">
        <h6 class="mb-2">Questions</h6>
        <div class="fs-3 fw-bold">{{ total_questions }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card p-3">
        <h6 class="mb-2">Submissions</h6>
        <div class="fs-3 fw-bold">{{ total_submissions }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card p-3">
        <h6 class="mb-2">Today</h6>
        <div class="fs-3 fw-bold">{{ submissions_today }}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card p-3">
        <h6 class="mb-2">Quizzes w/ 0Q</h6>
        <div class="fs-3 fw-bold">{{ quizzes_with_no_questions }}</div>
      </div>
    </div>
  </div>

  <div class="row g-4 mb-4">
    <div class="col-md-4">
      <div class="card p-3">
        <h6 class="mb-2">Quizzes with 0 questions</h6>
        <div class="fs-3 fw-bold">{{ quizzes_with_no_questions }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h6 class="mb-2">Pending AI Errors</h6>
        <div class="fs-3 fw-bold">{{ pending_ai_errors }}</div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3">
        <h6 class="mb-2">Average submission score</h6>
        <div class="fs-3 fw-bold">{% if avg_score %}{{ avg_score|floatformat:2 }}{% else %}N/A{% endif %}</div>
      </div>
    </div>
  </div>

  <div class="mb-4">
    <h5>Top performing users</h5>
    <ol class="mb-3">
      {% for user in top_users %}
      <li>{{ user.username }} â€” {{ user.user_rank.total_score|default:user.userrank.total_score }}</li>
      {% empty %}
      <li>No data</li>
      {% endfor %}
    </ol>
  </div>

  <!-- Upload Quiz Panel -->
  <div class="card mb-4 p-3">
    <h5 class="mb-3">Upload Quiz (XLSX / XLS / CSV)</h5>
    <form method="post" enctype="multipart/form-data" class="row g-3">
      {% csrf_token %}
      <input type="hidden" name="action" value="upload_quiz">
      <div class="col-md-4">
        <label class="form-label">Title</label>
        <input name="title" class="form-control" placeholder="Quiz title" required>
      </div>
      <div class="col-md-4">
        <label class="form-label">Category</label>
        <select name="category" class="form-select" required>
          <option value="">Choose category</option>
          {% for cat in categories %}
          <option value="{{ cat.id }}">{{ cat.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">File</label>
        <input name="quiz_file" type="file" class="form-control" accept=".xls,.xlsx,.csv" required>
      </div>
      <div class="col-12">
        <label class="form-label">Description (optional)</label>
        <input name="description" class="form-control" placeholder="Short description">
      </div>
      <div class="col-12 text-end">
        <button class="btn btn-primary" type="submit">Upload & Import</button>
      </div>
    </form>
  </div>

  <div>
    <h5>Recent submissions</h5>
    <table class="table table-sm">
      <thead>
        <tr>
          <th>Time</th>
          <th>User</th>
          <th>Quiz</th>
          <th>Score</th>
        </tr>
      </thead>
      <tbody>
        {% for s in recent_submissions %}
        <tr>
          <td>{{ s.submitted_at|naturaltime }}</td>
          <td><a href="{{ s.user.get_absolute_url|default:'#' }}">{{ s.user.username }}</a></td>
          <td>{{ s.quiz.title }}</td>
          <td>{{ s.score }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4">No recent submissions</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>