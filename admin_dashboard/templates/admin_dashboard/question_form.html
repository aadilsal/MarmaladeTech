{% extends 'admin_dashboard/base.html' %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <h1>
                <i class="bi bi-{% if question %}pencil{% else %}plus{% endif %}"></i>
                {% if question %}Edit{% else %}Create{% endif %} Question
            </h1>
            {% if question %}
                <p class="text-muted">Modify question details and answer choices</p>
            {% else %}
                <p class="text-muted">Create a new question with multiple choice answers</p>
            {% endif %}
        </div>
        <div class="page-actions">
            {% if question %}
                <a href="{% url 'admin_dashboard:question_detail' question.id %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Question
                </a>
            {% else %}
                <a href="{% url 'admin_dashboard:questions_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Questions
                </a>
            {% endif %}
        </div>
    </div>

    <!-- Form -->
    <div class="row">
        <div class="col-lg-8">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}

                <!-- Basic Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Basic Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.quiz.id_for_label }}" class="form-label">
                                Quiz *
                            </label>
                            {{ form.quiz }}
                            {% if form.quiz.errors %}
                                <div class="text-danger">{{ form.quiz.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.text.id_for_label }}" class="form-label">
                                Question Text *
                            </label>
                            {{ form.text }}
                            {% if form.text.errors %}
                                <div class="text-danger">{{ form.text.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.image.id_for_label }}" class="form-label">
                                Question Image
                            </label>
                            {{ form.image }}
                            {% if form.image.errors %}
                                <div class="text-danger">{{ form.image.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">Optional image to display with the question</div>
                        </div>
                    </div>
                </div>

                <!-- Answer Choices -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Answer Choices</h5>
                    </div>
                    <div class="card-body">
                        {% if question %}
                            {% for choice in question.choice_set.all %}
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <input type="radio" name="correct_choice" value="{{ choice.id }}"
                                                   {% if choice.is_correct %}checked{% endif %}>
                                        </span>
                                        <input type="text" class="form-control" name="choice_{{ choice.id }}"
                                               value="{{ choice.text }}" placeholder="Choice {{ forloop.counter }}">
                                        <button type="button" class="btn btn-outline-danger"
                                                onclick="removeChoice({{ choice.id }})">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div id="choicesContainer">
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <input type="radio" name="correct_choice" value="1" checked>
                                        </span>
                                        <input type="text" class="form-control" name="choice_1" placeholder="Choice A (Correct)">
                                        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(1)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <input type="radio" name="correct_choice" value="2">
                                        </span>
                                        <input type="text" class="form-control" name="choice_2" placeholder="Choice B">
                                        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(2)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <input type="radio" name="correct_choice" value="3">
                                        </span>
                                        <input type="text" class="form-control" name="choice_3" placeholder="Choice C">
                                        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(3)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <input type="radio" name="correct_choice" value="4">
                                        </span>
                                        <input type="text" class="form-control" name="choice_4" placeholder="Choice D">
                                        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(4)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary" onclick="addChoice()">
                                <i class="bi bi-plus"></i> Add Choice
                            </button>
                        {% endif %}
                    </div>
                </div>

                <!-- Explanation -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">Explanation</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.explanation.id_for_label }}" class="form-label">
                                Manual Explanation
                            </label>
                            {{ form.explanation }}
                            {% if form.explanation.errors %}
                                <div class="text-danger">{{ form.explanation.errors.0 }}</div>
                            {% endif %}
                            <div class="form-text">
                                Optional manual explanation. Leave blank to use AI-generated explanation.
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Submit -->
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check"></i>
                        {% if question %}Update{% else %}Create{% endif %} Question
                    </button>
                    {% if question %}
                        <a href="{% url 'admin_dashboard:question_detail' question.id %}" class="btn btn-secondary">
                            <i class="bi bi-x"></i> Cancel
                        </a>
                    {% else %}
                        <a href="{% url 'admin_dashboard:questions_list' %}" class="btn btn-secondary">
                            <i class="bi bi-x"></i> Cancel
                        </a>
                    {% endif %}
                </div>
            </form>
        </div>

        <div class="col-lg-4">
            <!-- Help Card -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="bi bi-info-circle"></i> Help</h6>
                </div>
                <div class="card-body">
                    <h6>Question Text</h6>
                    <p class="small text-muted mb-3">Write a clear, unambiguous question.</p>

                    <h6>Answer Choices</h6>
                    <p class="small text-muted mb-3">Provide 2-6 answer choices. Mark the correct one with the radio button.</p>

                    <h6>Explanation</h6>
                    <p class="small text-muted mb-3">Manual explanation takes precedence over AI-generated ones.</p>

                    <h6>AI Generation</h6>
                    <p class="small text-muted">If no manual explanation is provided, the system can generate one using AI.</p>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
let choiceCounter = 5;

function addChoice() {
    const container = document.getElementById('choicesContainer');
    const choiceDiv = document.createElement('div');
    choiceDiv.className = 'mb-3';
    const choiceLetter = String.fromCharCode(64 + choiceCounter);
    choiceDiv.innerHTML = `
        <div class="input-group">
            <span class="input-group-text">
                <input type="radio" name="correct_choice" value="${choiceCounter}">
            </span>
            <input type="text" class="form-control" name="choice_${choiceCounter}" placeholder="Choice ${choiceLetter}">
            <button type="button" class="btn btn-outline-danger" onclick="removeChoice(${choiceCounter})">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
    container.appendChild(choiceDiv);
    choiceCounter++;
}

function removeChoice(choiceId) {
    const choiceElement = document.querySelector('input[name="choice_' + choiceId + '"]');
    if (choiceElement) {
        choiceElement.closest('.mb-3').remove();
    }
}
</script>
{% endblock %}
{% endblock %}