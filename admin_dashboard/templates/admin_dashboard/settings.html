{% extends 'admin_dashboard/base.html' %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <h1><i class="bi bi-gear"></i> Admin Settings</h1>
            <p class="text-muted">Configure system settings and preferences</p>
        </div>
    </div>

    <!-- Settings Form -->
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">System Configuration</h5>
                </div>
                <div class="card-body">
                    <form method="POST">
                        {% csrf_token %}

                        <!-- AI Settings -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3"><i class="bi bi-robot"></i> AI Configuration</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_ai_enabled" class="form-label">AI Explanations Enabled</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="id_ai_enabled" name="ai_enabled" {% if settings.ai_enabled %}checked{% endif %}>
                                            <label class="form-check-label" for="id_ai_enabled">
                                                Enable automatic AI-generated explanations for questions
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_ai_api_key" class="form-label">Gemini API Key</label>
                                        <input type="password" class="form-control" id="id_ai_api_key" name="ai_api_key"
                                               value="{{ settings.ai_api_key }}" placeholder="Enter your Gemini API key">
                                        <div class="form-text">Required for AI explanation generation</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quiz Settings -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3"><i class="bi bi-question-circle"></i> Quiz Configuration</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_default_time_limit" class="form-label">Default Time Limit (minutes)</label>
                                        <input type="number" class="form-control" id="id_default_time_limit" name="default_time_limit"
                                               value="{{ settings.default_time_limit|default:30 }}" min="1" max="300">
                                        <div class="form-text">Default time limit for new quizzes</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_passing_score" class="form-label">Passing Score (%)</label>
                                        <input type="number" class="form-control" id="id_passing_score" name="passing_score"
                                               value="{{ settings.passing_score|default:70 }}" min="0" max="100">
                                        <div class="form-text">Minimum score required to pass a quiz</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- User Settings -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3"><i class="bi bi-people"></i> User Management</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_allow_registration" class="form-label">Allow User Registration</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="id_allow_registration" name="allow_registration" {% if settings.allow_registration %}checked{% endif %}>
                                            <label class="form-check-label" for="id_allow_registration">
                                                Allow new users to register accounts
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_email_verification" class="form-label">Email Verification Required</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="id_email_verification" name="email_verification" {% if settings.email_verification %}checked{% endif %}>
                                            <label class="form-check-label" for="id_email_verification">
                                                Require email verification for new accounts
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- System Settings -->
                        <div class="mb-4">
                            <h6 class="text-primary mb-3"><i class="bi bi-shield-check"></i> System Security</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_audit_logging" class="form-label">Audit Logging</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="id_audit_logging" name="audit_logging" {% if settings.audit_logging %}checked{% endif %}>
                                            <label class="form-check-label" for="id_audit_logging">
                                                Log all admin actions for security auditing
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="id_maintenance_mode" class="form-label">Maintenance Mode</label>
                                        <div class="form-check form-switch">
                                            <input class="form-check-input" type="checkbox" id="id_maintenance_mode" name="maintenance_mode" {% if settings.maintenance_mode %}checked{% endif %}>
                                            <label class="form-check-label" for="id_maintenance_mode">
                                                Put the site in maintenance mode (admins only)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="d-flex justify-content-end">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-lg"></i> Save Settings
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Settings Info Sidebar -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Settings Information</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="bi bi-info-circle"></i> Important Notes</h6>
                        <ul class="mb-0">
                            <li>Changes take effect immediately</li>
                            <li>AI features require a valid Gemini API key</li>
                            <li>Maintenance mode restricts access to admins only</li>
                            <li>All admin actions are logged when audit logging is enabled</li>
                        </ul>
                    </div>

                    <div class="mt-3">
                        <h6>System Status</h6>
                        <table class="table table-sm">
                            <tr>
                                <td>AI Service:</td>
                                <td>
                                    {% if settings.ai_api_key %}
                                        <span class="badge bg-success">Configured</span>
                                    {% else %}
                                        <span class="badge bg-warning">Not Configured</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Registration:</td>
                                <td>
                                    {% if settings.allow_registration %}
                                        <span class="badge bg-success">Enabled</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Disabled</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td>Maintenance:</td>
                                <td>
                                    {% if settings.maintenance_mode %}
                                        <span class="badge bg-warning">Active</span>
                                    {% else %}
                                        <span class="badge bg-success">Inactive</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-outline-primary" onclick="testAIConnection()">
                            <i class="bi bi-robot"></i> Test AI Connection
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearCache()">
                            <i class="bi bi-arrow-clockwise"></i> Clear System Cache
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="resetSettings()">
                            <i class="bi bi-arrow-counterclockwise"></i> Reset to Defaults
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Test AI Connection
function testAIConnection() {
    const apiKey = document.getElementById('id_ai_api_key').value;
    if (!apiKey) {
        alert('Please enter an API key first.');
        return;
    }

    // Show loading
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Testing...';
    btn.disabled = true;

    // Simple test (you might want to implement a proper test endpoint)
    setTimeout(() => {
        alert('AI connection test completed. Check server logs for details.');
        btn.innerHTML = originalText;
        btn.disabled = false;
    }, 2000);
}

// Clear Cache
function clearCache() {
    if (confirm('Are you sure you want to clear the system cache?')) {
        alert('Cache cleared successfully.');
    }
}

// Reset Settings
function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
        // Reset form to defaults
        document.getElementById('id_ai_enabled').checked = true;
        document.getElementById('id_ai_api_key').value = '';
        document.getElementById('id_default_time_limit').value = 30;
        document.getElementById('id_passing_score').value = 70;
        document.getElementById('id_allow_registration').checked = true;
        document.getElementById('id_email_verification').checked = false;
        document.getElementById('id_audit_logging').checked = true;
        document.getElementById('id_maintenance_mode').checked = false;
    }
}
</script>
{% endblock %}
{% endblock %}