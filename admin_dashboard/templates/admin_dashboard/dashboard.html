{% extends 'admin_dashboard/base.html' %}

{% block content %}
<div class="dashboard-container">
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-people"></i>
            </div>
            <div class="stats-content">
                <h3>{{ stats.total_users }}</h3>
                <p>Total Users</p>
                <span class="stats-change positive">+{{ stats.user_growth_30d }} this month</span>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-person-check"></i>
            </div>
            <div class="stats-content">
                <h3>{{ stats.active_users_7d }}</h3>
                <p>Active Users (7d)</p>
                <span class="stats-change">Last 7 days</span>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-question-circle"></i>
            </div>
            <div class="stats-content">
                <h3>{{ stats.total_questions }}</h3>
                <p>Total Questions</p>
                <span class="stats-change">In system</span>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-list-check"></i>
            </div>
            <div class="stats-content">
                <h3>{{ stats.total_quizzes }}</h3>
                <p>Total Quizzes</p>
                <span class="stats-change">Created</span>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-bar-chart"></i>
            </div>
            <div class="stats-content">
                <h3>{{ stats.total_attempts }}</h3>
                <p>Total Attempts</p>
                <span class="stats-change">All time</span>
            </div>
        </div>

        <div class="stats-card">
            <div class="stats-icon">
                <i class="bi bi-trophy"></i>
            </div>
            <div class="stats-content">
                <h3>{{ stats.avg_score|floatformat:1 }}%</h3>
                <p>Average Score</p>
                <span class="stats-change">Overall</span>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
        <div class="chart-card">
            <div class="card-header">
                <h5>User Growth</h5>
            </div>
            <div class="card-body">
                <canvas id="userGrowthChart" width="400" height="200"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <div class="card-header">
                <h5>Quiz Attempts Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="quizAttemptsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="activity-row">
        <div class="activity-card">
            <div class="card-header">
                <h5>Recent User Registrations</h5>
            </div>
            <div class="card-body">
                <div class="activity-list">
                    {% for user in stats.recent_registrations %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-person-plus"></i>
                        </div>
                        <div class="activity-content">
                            <p><strong>{{ user.username }}</strong> registered</p>
                            <small>{{ user.date_joined|date:"M d, Y" }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="activity-card">
            <div class="card-header">
                <h5>Recent Quiz Attempts</h5>
            </div>
            <div class="card-body">
                <div class="activity-list">
                    {% for attempt in stats.recent_attempts %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="activity-content">
                            <p><strong>{{ attempt.user.username }}</strong> attempted <strong>{{ attempt.quiz.title }}</strong></p>
                            <small>Score: {{ attempt.score }}% â€¢ {{ attempt.submitted_at|date:"M d, Y H:i" }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="activity-card">
            <div class="card-header">
                <h5>Recent Questions Added</h5>
            </div>
            <div class="card-body">
                <div class="activity-list">
                    {% for question in stats.recent_questions %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                        <div class="activity-content">
                            <p>New question added</p>
                            <small>{{ question.text|truncatechars:50 }}</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="quick-actions">
        <h5>Quick Actions</h5>
        <div class="action-buttons">
            <a href="{% url 'admin_dashboard:user_create' %}" class="btn btn-primary">
                <i class="bi bi-person-plus me-2"></i>Add User
            </a>
            <a href="{% url 'admin_dashboard:question_create' %}" class="btn btn-success">
                <i class="bi bi-plus-circle me-2"></i>Add Question
            </a>
            <a href="{% url 'admin_dashboard:quiz_create' %}" class="btn btn-info">
                <i class="bi bi-list-check me-2"></i>Create Quiz
            </a>
            <a href="{% url 'admin_dashboard:analytics' %}" class="btn btn-secondary">
                <i class="bi bi-graph-up me-2"></i>View Analytics
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // User Growth Chart
    fetch('{% url "admin_dashboard:api_user_growth_chart" %}')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('userGrowthChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.data.map(item => item.date),
                    datasets: [{
                        label: 'New Users',
                        data: data.data.map(item => item.count),
                        borderColor: 'rgb(0, 123, 255)',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });

    // Quiz Attempts Chart
    fetch('{% url "admin_dashboard:api_quiz_trends_chart" %}')
        .then(response => response.json())
        .then(data => {
            const ctx = document.getElementById('quizAttemptsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.data.map(item => item.date),
                    datasets: [{
                        label: 'Quiz Attempts',
                        data: data.data.map(item => item.count),
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: 'rgb(40, 167, 69)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        });
});
</script>
{% endblock %}