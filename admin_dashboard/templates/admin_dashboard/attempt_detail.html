{% extends 'admin_dashboard/base.html' %}

{% block content %}
<div class="dashboard-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-title">
            <h1><i class="bi bi-bar-chart"></i> Quiz Attempt Details</h1>
            <p class="text-muted">Detailed view of quiz submission</p>
        </div>
        <div class="page-actions">
            <a href="{% url 'admin_dashboard:attempts_list' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Attempts
            </a>
            <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                <i class="bi bi-trash"></i> Delete Attempt
            </button>
        </div>
    </div>

    <!-- Attempt Overview -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="card-title">Attempt Information</h5>
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-bold">User:</td>
                                    <td>{{ attempt.user.username }} ({{ attempt.user.email }})</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Quiz:</td>
                                    <td>{{ attempt.quiz.title }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Category:</td>
                                    <td>{{ attempt.quiz.category.name }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Score:</td>
                                    <td>
                                        <span class="badge bg-{% if attempt.score > 70 %}success{% elif attempt.score > 40 %}warning{% else %}danger{% endif %} fs-6">
                                            {{ attempt.score }}%
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Submitted:</td>
                                    <td>{{ attempt.submitted_at|date:"M d, Y H:i" }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Time Taken:</td>
                                    <td>{{ attempt.time_taken|default:"N/A" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5 class="card-title">Performance Summary</h5>
                            <div class="mb-3">
                                <div class="progress" style="height: 20px;">
                                    <div class="progress-bar bg-{% if attempt.score > 70 %}success{% elif attempt.score > 40 %}warning{% else %}danger{% endif %}"
                                         style="width: {{ attempt.score }}%">
                                        {{ attempt.score }}%
                                    </div>
                                </div>
                            </div>
                            <table class="table table-sm">
                                <tr>
                                    <td class="fw-bold">Total Questions:</td>
                                    <td>{{ attempt.quiz.questions.count }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Correct Answers:</td>
                                    <td>{{ correct_answers }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Incorrect Answers:</td>
                                    <td>{{ incorrect_answers }}</td>
                                </tr>
                                <tr>
                                    <td class="fw-bold">Unanswered:</td>
                                    <td>{{ unanswered }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Quick Actions</h5>
                    <div class="d-grid gap-2">
                        <a href="{% url 'admin_dashboard:user_detail' attempt.user.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-person"></i> View User Profile
                        </a>
                        <a href="{% url 'admin_dashboard:quiz_detail' attempt.quiz.id %}" class="btn btn-outline-primary">
                            <i class="bi bi-question-circle"></i> View Quiz Details
                        </a>
                        <a href="{% url 'admin_dashboard:analytics' %}?user={{ attempt.user.id }}" class="btn btn-outline-primary">
                            <i class="bi bi-graph-up"></i> User Analytics
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Question by Question Review -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">Question by Question Review</h5>
        </div>
        <div class="card-body p-0">
            {% for answer in answers %}
                <div class="border-bottom p-3">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="mb-2">Question {{ forloop.counter }}</h6>
                            <p class="mb-3">{{ answer.question.question_text }}</p>

                            {% if answer.question.image %}
                                <img src="{{ answer.question.image.url }}" alt="Question Image" class="img-fluid mb-3" style="max-width: 300px;">
                            {% endif %}

                            <div class="mb-3">
                                <strong>Options:</strong>
                                <ol type="A">
                                    {% for choice in answer.question.choices.all %}
                                        <li class="{% if choice.is_correct %}text-success fw-bold{% elif answer.selected_choice == choice %}text-danger{% endif %}">
                                            {{ choice.choice_text }}
                                            {% if choice.is_correct %}
                                                <i class="bi bi-check-circle-fill text-success"></i>
                                            {% elif answer.selected_choice == choice %}
                                                <i class="bi bi-x-circle-fill text-danger"></i>
                                            {% endif %}
                                        </li>
                                    {% endfor %}
                                </ol>
                            </div>

                            {% if answer.question.explanation %}
                                <div class="alert alert-info">
                                    <strong>Explanation:</strong><br>
                                    {{ answer.question.explanation }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                {% if answer.is_correct %}
                                    <div class="text-success mb-2">
                                        <i class="bi bi-check-circle-fill fs-1"></i>
                                        <h6>Correct</h6>
                                    </div>
                                {% else %}
                                    <div class="text-danger mb-2">
                                        <i class="bi bi-x-circle-fill fs-1"></i>
                                        <h6>Incorrect</h6>
                                    </div>
                                {% endif %}

                                {% if answer.selected_choice %}
                                    <small class="text-muted">
                                        Selected: {{ answer.selected_choice.get_choice_letter }}
                                    </small>
                                {% else %}
                                    <small class="text-muted">Not answered</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-4">
                    <div class="text-muted">
                        <i class="bi bi-question-circle fs-1 d-block mb-2"></i>
                        No answers found for this attempt.
                    </div>
                </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this quiz attempt?</p>
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    This action cannot be undone. It will affect user statistics and rankings.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{% url 'admin_dashboard:attempt_delete' attempt.id %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete Attempt</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function confirmDelete() {
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
</script>
{% endblock %}
{% endblock %}